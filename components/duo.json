{
  "static/init.js": {
    "id": "static/init.js",
    "type": "js",
    "mtime": 1442758779000,
    "src": "'use strict';\n\nlet events = require(\"./events.js\");\nlet msgpack = require(\"msgpack-js\");\n\nclass TerminalLine {\n\tconstructor (message) {\n\t\tthis.element = document.createElement('line');\n\n\t\tthis.setMessage(message);\n\t}\n\n\tsetMessage (message) {\n\t\tthis.element.innerHTML = message;\n\t}\n\n\tgetElement () {\n\t\treturn this.element;\n\t}\n};\n\nclass TerminalCommandLine {\n\tconstructor () {\n\t\tthis.element = document.createElement('inputline');\n\t\tthis.prompt = document.createElement('prompt');\n\t\tthis.input = document.createElement('input');\n\t\t\n\t\tthis.input.className = 'command';\n\n\t\tthis.element.appendChild(this.prompt);\n\t\tthis.element.appendChild(this.input);\n\t}\n\n\tsetDisabled (disabled) {\n\t\tthis.input.setAttribute('disabled', disabled);\n\t}\n\n\tsetAutofocus () {\n\t\tthis.input.setAttribute('autofocus', true);\n\t}\n\n\tsetInput (message) {\n\t\tthis.input.value = message;\n\t}\n\n\tsetPrompt (prompt) {\n\t\tthis.prompt.innerText = prompt;\n\t}\n\n\tgetElement () {\n\t\treturn this.element;\n\t}\n};\n\nclass TerminalLineFeed {\n\tconstructor (output) {\n\t\tthis.lineFeed = [];\n\t\tthis.output = output;\n\t}\n\n\tpush (line) {\n\t\tthis.output.appendChild(line.getElement());\n\t\tthis.lineFeed.push(line);\n\t}\n\n\tremove (line) {\n\t\tthis.output.removeChild(line.getElement());\n\n\t\tlet itemPos = this.lineFeed.indexOf(line);\n\n\t\tif (~itemPos) {\n\t\t\tthis.lineFeed = Array.prototype.concat.call(\n\t\t\t\tthis.lineFeed.slice(0, itemPos),\n\t\t\t\tthis.lineFeed.slice(itemPos + 1, this.lineFeed.length - 1)\n\t\t\t);\n\t\t}\n\t}\n\n\tremoveAllLines () {\n\t\tthis.lineFeed.forEach((line) => this.remove(line));\n\t}\n\n\tremoveLastPartial () {\n\t\tlet lastCommandLine;\n\n\t\tfor (let i = this.lineFeed.length; i >= 0; --i) {\n\t\t\tif (this.lineFeed[i] instanceof TerminalCommandLine) {\n\t\t\t\tlastCommandLine = this.lineFeed[i];\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (lastCommandLine === undefined) return;\n\n\t\tthis.lineFeed.slice(this.lineFeed.indexOf(lastCommandLine)).forEach((line) => {\n\t\t\tthis.remove(line);\n\t\t})\n\t}\n}\n\nclass Terminal extends events {\n\tconstructor () {\n\t\tsuper();\n\n\t\tthis.init();\n\n\t\tthis.registerEvents();\n\t}\n\n\tinit () {\n\t\tthis.prefixMeta = {\n\t\t\tname: 'nobody',\n\t\t\tinstance: 'apx',\n\t\t\turi: '~'\n\t\t};\n\n\t\tthis.container = this._initContainer();\n\n\t\tthis.command = this.container.querySelector('inputline .command');\n\t\tthis.output = this.container.querySelector('output');\n\n\t\tthis.lineFeed = new TerminalLineFeed(this.output);\n\t\tthis.commandFeed = [];\n\t}\n\n\t_inputLine (readOnly) {\n\t\treturn new TerminalCommandLine ();\n\t}\n\n\t_getPromptPrefix () {\n\t\treturn this.prefixMeta.name\n\t\t\t   + '@' + this.prefixMeta.instance\n\t\t\t   + ':' + this.prefixMeta.uri + '$';\n\t}\n\t_commitPromptPrefix () {\n\t\tlet promptPrefix = this._getPromptPrefix();\n\n\t\tthis.inputLine.setPrompt(promptPrefix);\n\t}\n\n\t_initContainer () {\n\t\tlet container = document.createElement('cream');\n\t\tcontainer.className = 'box';\n\n\t\tthis.output = document.createElement('output');\n\n\t\tthis.inputLine = this._inputLine();\n\t\tthis.inputLine.setAutofocus(true);\n\n\t\tthis._commitPromptPrefix();\n\n\t\tdocument.body.appendChild(container);\n\n\t\tcontainer.appendChild(this.output);\n\t\tcontainer.appendChild(this.inputLine.getElement());\n\n\t\treturn container;\n\t}\n\n\tregisterEvents() {\n\t\tthis.command.addEventListener('keydown', (e) => {\n\t\t\tif (e.metaKey) {\n\t\t\t\te.preventDefault();\n\n\t\t\t\tswitch (e.keyCode) {\n\t\t\t\t\tcase 75: return this.clearTerminal();\n\t\t\t\t\tcase 76: return this.partialClearTerminal();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (e.keyCode === 13) {\n\t\t\t\t// jump list\n\t\t\t\tswitch (this.command.value) {\n\t\t\t\t\tcase 'clear':\n\t\t\t\t\t\treturn this.resetTerminal();\n\t\t\t\t}\n\n\t\t\t\tthis.disableTerminal();\n\t\t\t\tthis.emit('command', this.command.value);\n\t\t\t}\n\t\t}, true);\n\t}\n\n\t// write partial message, non-exit\n\twrite (msg) {\n\t\tlet fakeInputLine = new TerminalCommandLine();\n\n\t\tfakeInputLine.setDisabled(true);\n\t\tfakeInputLine.setInput(this.command.value);\n\t\tfakeInputLine.setPrompt(this._getPromptPrefix());\n\n\t\tthis.lineFeed.push(fakeInputLine);\n\n\t\tthis.writeRaw(msg);\n\t}\n\n\twriteRaw (msg) {\n\t\tmsg = msg.split('\\n').map((line) => line.trim());\n\t\tmsg = msg.map((line) => {\n\t\t\treturn new TerminalLine(line);\n\t\t});\n\n\t\tmsg.forEach((line) => {\n\t\t\tthis.lineFeed.push(line);\n\t\t});\n\t}\n\n\t// quit command\n\tcommit (msg) {\n\t\tthis.command.value = '';\n\t\tthis.command.disabled = false;\n\n\t\tthis.command.focus();\n\t\tthis.command.scrollIntoView();\n\t}\n\n\t// divers commands\n\tclearTerminal () {\n\t\tthis.lineFeed.removeAllLines();\n\t}\n\n\tpartialClearTerminal () {\n\t\tthis.lineFeed.removeLastPartial();\n\t}\n\n\tresetTerminal () {\n\t\tthis.clearTerminal();\n\t\tthis.command.value = '';\n\t}\n\n\tdisableTerminal () {\n\t\tthis.command.disabled = true;\n\t}\n};\n\nclass apx extends events {\n\tconstructor () {\n\t\tsuper();\n\n\t\tthis.initKeychain();\n\t\tthis.registerRealtime();\n\n\t\tif (localStorage.id) {\n\t\t\tthis.handshake();\n\t\t} else {\n\t\t\tthis.initTerminal();\n\t\t}\n\t}\n\n\tinitKeychain () {\n\t\tthis.keypair = sodium.crypto_box_keypair();\n\t\tthis.nonce = sodium.randombytes_buf(32);\n\n\t\tlet secret = String(location.hash.slice(1));\n\t\tthis.secret = sodium.crypto_generichash(32, secret, this.nonce);\n\n\t\t// overwrite secret\n\t\tfor(let i = 0; i < 30; ++i)\n\t\t\tsecret = String.fromCharCode.apply(String, sodium.randombytes_buf(64));\n\n\t\tthis.authedHandshake = sodium.crypto_auth(this.keypair.publicKey, this.secret);\n\t}\n\n\tinitSecureChannel () {\n\t\tsodium.crypto_scalarmult(this.keypair.publicKey, this.keypair.privateKey);\n\t}\n\n\tregisterRealtime () {\n\t\tthis.io = io();\n\n\t\tthis.io.on('hi', (msg) => {\n\t\t\tif (!this.terminal) {\n\t\t\t\tthis.initTerminal();\n\t\t\t}\n\t\t});\n\n\t\tthis.io.on('prefix', (prefix) => {\n\n\t\t})\n\t}\n\n\thandshake () {\n\t\tlet user = localStorage.id;\n\n\t\tlet arr = (item) => String.fromCharCode.apply(null, item);//Array.prototype.slice.call(item);\n\n\t\tlet seed = {\n\t\t\tuser: user,\n\t\t\tnonce: arr(this.nonce),\n\t\t\tpublicKey: arr(this.keypair.publicKey),\n\t\t\tauthedHandshake: arr(this.authedHandshake)\n\t\t};\n\n\t\tthis.io.emit('login', seed);\n\t}\n\n\tbufcmp (buf1, buf2) {\n\t\tif (buf1.length !== buf2.length) return false;\n\n\t\tfor(let i = 0; i < buf2.length; ++i)\n\t\t\tif (buf1[i] !== buf2[i]) return false;\n\n\t\treturn true;\n\t}\n\n\tinitTerminal () {\n\t\tthis.terminal = new Terminal();\n\n\t\tif (this.bufcmp(this.secret, sodium.crypto_generichash(32, '', this.nonce))) {\n\t\t\tthis.terminal.write('Bad secret');\n\t\t}\n\n\t\tthis.terminal.on('command', (msg) => {\n\t\t\tlet _msg = msg.trim().split(' ');\n\n\t\t\tif (this.authenticated) {\n\t\t\t} else {\n\t\t\t\tif (_msg.length !== 2 || _msg[0] !== 'login') {\n\t\t\t\t\tthis.terminal.write('Not authenticated.');\n\t\t\t\t\tthis.terminal.commit();\n\t\t\t\t} else {\n\t\t\t\t\tlocalStorage.id = _msg[1];\n\n\t\t\t\t\tthis.handshake();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n};\n\nnew apx();",
    "deps": {
      "./events.js": "static/events.js"
    },
    "entry": true
  },
  "static/events.js": {
    "id": "static/events.js",
    "type": "js",
    "mtime": 1442597539000,
    "src": "var domain;function EventEmitter(){EventEmitter.init.call(this)}module.exports=EventEmitter;EventEmitter.EventEmitter=EventEmitter;EventEmitter.usingDomains=!1;EventEmitter.prototype.domain=void 0;EventEmitter.prototype._events=void 0;EventEmitter.prototype._maxListeners=void 0;EventEmitter.defaultMaxListeners=10; EventEmitter.init=function(){this.domain=null;EventEmitter.usingDomains&&(domain=domain||require(\"domain\"),!domain.active||this instanceof domain.Domain||(this.domain=domain.active));this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events={},this._eventsCount=0);this._maxListeners=this._maxListeners||void 0};EventEmitter.prototype.setMaxListeners=function(b){if(\"number\"!==typeof b||0>b||isNaN(b))throw new TypeError(\"n must be a positive number\");this._maxListeners=b;return this}; function $getMaxListeners(b){return void 0===b._maxListeners?EventEmitter.defaultMaxListeners:b._maxListeners}EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)};function emitNone(b,a,c){if(a)b.call(c);else{a=b.length;b=arrayClone(b,a);for(var d=0;d<a;++d)b[d].call(c)}}function emitOne(b,a,c,d){if(a)b.call(c,d);else{a=b.length;b=arrayClone(b,a);for(var e=0;e<a;++e)b[e].call(c,d)}} function emitTwo(b,a,c,d,e){if(a)b.call(c,d,e);else{a=b.length;b=arrayClone(b,a);for(var f=0;f<a;++f)b[f].call(c,d,e)}}function emitThree(b,a,c,d,e,f){if(a)b.call(c,d,e,f);else{a=b.length;b=arrayClone(b,a);for(var g=0;g<a;++g)b[g].call(c,d,e,f)}}function emitMany(b,a,c,d){if(a)b.apply(c,d);else{a=b.length;b=arrayClone(b,a);for(var e=0;e<a;++e)b[e].apply(c,d)}} EventEmitter.prototype.emit=function(b){var a,c,d,e,f,g;a=!1;d=\"error\"===b;if(c=this._events)d=d&&null==c.error;else if(!d)return!1;g=this.domain;if(d){a=arguments[1];if(g)a||(a=Error('Uncaught, unspecified \"error\" event.')),a.domainEmitter=this,a.domain=g,a.domainThrown=!1,g.emit(\"error\",a);else{if(a instanceof Error)throw a;g=Error('Uncaught, unspecified \"error\" event. ('+a+\")\");g.context=a;throw g;}return!1}c=c[b];if(!c)return!1;g&&(g.enter(),a=!0);var h=\"function\"===typeof c;d=arguments.length; switch(d){case 1:emitNone(c,h,this);break;case 2:emitOne(c,h,this,arguments[1]);break;case 3:emitTwo(c,h,this,arguments[1],arguments[2]);break;case 4:emitThree(c,h,this,arguments[1],arguments[2],arguments[3]);break;default:e=Array(d-1);for(f=1;f<d;f++)e[f-1]=arguments[f];emitMany(c,h,this,e)}a&&g.exit();return!0}; EventEmitter.prototype.addListener=function(b,a){var c,d;if(\"function\"!==typeof a)throw new TypeError(\"listener must be a function\");(c=this._events)?(c.newListener&&(this.emit(\"newListener\",b,a.listener?a.listener:a),c=this._events),d=c[b]):(c=this._events={},this._eventsCount=0);d?(\"function\"===typeof d?d=c[b]=[d,a]:d.push(a),d.warned||(c=$getMaxListeners(this))&&0<c&&d.length>c&&(d.warned=!0,console.error(\"(node) warning: possible EventEmitter memory leak detected. %d %s listeners added. Use emitter.setMaxListeners() to increase limit.\", d.length,b),console.trace())):(c[b]=a,++this._eventsCount);return this};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.once=function(b,a){function c(){this.removeListener(b,c);d||(d=!0,a.apply(this,arguments))}if(\"function\"!==typeof a)throw new TypeError(\"listener must be a function\");var d=!1;c.listener=a;this.on(b,c);return this}; EventEmitter.prototype.removeListener=function(b,a){var c,d,e,f;if(\"function\"!==typeof a)throw new TypeError(\"listener must be a function\");d=this._events;if(!d)return this;c=d[b];if(!c)return this;if(c===a||c.listener&&c.listener===a)0===--this._eventsCount?this._events={}:(delete d[b],d.removeListener&&this.emit(\"removeListener\",b,a));else if(\"function\"!==typeof c){e=-1;for(f=c.length;0<f--;)if(c[f]===a||c[f].listener&&c[f].listener===a){e=f;break}if(0>e)return this;if(1===c.length){c[0]=void 0; if(0===--this._eventsCount)return this._events={},this;delete d[b]}else spliceOne(c,e);d.removeListener&&this.emit(\"removeListener\",b,a)}return this}; EventEmitter.prototype.removeAllListeners=function(b){var a;a=this._events;if(!a)return this;if(!a.removeListener)return 0===arguments.length?(this._events={},this._eventsCount=0):a[b]&&(0===--this._eventsCount?this._events={}:delete a[b]),this;if(0===arguments.length){a=Object.keys(a);for(var c=0,d;c<a.length;++c)d=a[c],\"removeListener\"!==d&&this.removeAllListeners(d);this.removeAllListeners(\"removeListener\");this._events={};this._eventsCount=0;return this}a=a[b];if(\"function\"===typeof a)this.removeListener(b, a);else if(a){do this.removeListener(b,a[a.length-1]);while(a[0])}return this};EventEmitter.prototype.listeners=function(b){var a=this._events;b=a?(b=a[b])?\"function\"===typeof b?[b]:arrayClone(b,b.length):[]:[];return b};EventEmitter.listenerCount=function(b,a){return\"function\"===typeof b.listenerCount?b.listenerCount(a):listenerCount.call(b,a)};EventEmitter.prototype.listenerCount=listenerCount; function listenerCount(b){var a=this._events;if(a){b=a[b];if(\"function\"===typeof b)return 1;if(b)return b.length}return 0}function spliceOne(b,a){for(var c=a,d=c+1,e=b.length;d<e;c+=1,d+=1)b[c]=b[d];b.pop()}function arrayClone(b,a){for(var c=Array(a);a--;)c[a]=b[a];return c}",
    "deps": {}
  }
}